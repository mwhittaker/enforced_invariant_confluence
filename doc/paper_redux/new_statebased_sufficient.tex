\section{New Sufficient State-Based Conditions}
\todo{%
  Revise everything with new notation of $(O, T)$ \Iconfluent{} instead of $T$
  \Iconfluent{}.
}

\algoref{InteractiveDecisionProcedure} relies on a user to provide information
about reachable and unreachable states. In this section, we outline a new
sufficient condition for state-based \Iconfluence{} that does not require user
interaction and that covers some cases not covered by the sufficient conditions
in \clmref{StateBasedSufficient}. To prove that the new condition is
sufficient, we introduce the concepts of \dIconfluence{} and \dIreduction{}.

\begin{definition}
  A \defword{join-free} expression $e = t_1(t_2(\ldots t_n(s_0) \ldots))$ is an
  expression that does not contain a join.
\end{definition}

\begin{definition}
  $T$ is \defword{\dIconfluent{}} if for every pair $e_1$ and $e_2$ of
  join-free expressions, $\Irec{e_1}$ and $\Irec{e_2}$ implies that $I(e_1
  \join e_2)$.
\end{definition}

Intuitively, \dIconfluence{} is the same thing as \Iconfluence{} with
the added restriction that subexpressions are join-free.

\begin{definition}
  $T$ is \defword{\dIreducible{}} if for every pair $e_1$ and $e_2$ of
  join-free expressions, $\Irec{e_1 \join e_2}$ implies that there exists some
  join-free expression $e_3$ such that $\Irec{e_3}$ and $eval(e3) = eval(e1
  \join e_2)$.
\end{definition}

Intuitively, \dIreduction{} allows us to eliminate join operators by
substituting $e_1 \join e_2$ (which contains 1 join) with $e_3$ (which does not
contain any joins).

% \input{diconfluence_direduction.fig}
%
% We can also interpret \dIconfluence{} and \dIreduction{} using the graph-based
% model of \Iconfluence{}, as illustrated in
% \figref{diconfluence_and_direduction}. Intuitively, \dIconfluence{} is the
% property that any two divergent join-free paths that satisfy $I$ can be joined
% together to form a new state that satisfies $I$. \dIreduction{} is the property
% that the join of any two divergent join-free paths that satisfy $I$ can be
% replaced with a single join-free path that satisfies $I$. Both conditions
% involve diamond diagrams, hence the names \dIconfluence{} and \dIreduction{}.

\begin{claim}\clmlabel{DiconfluenceDireducibleImpliesIconfluence}
  If $T$ is \dIconfluent{} and \dIreducible, then it is \Iconfluent.
\end{claim}
\begin{elidableproof}
  First, we prove that for all $e$, if $\Irec{e}$ then there exists a join-free
  $e'$ where $\Irec{e'}$ and $eval(e) = eval(e')$. We proceed by a pretty
  straightforward structural induction on $e$.
  \begin{itemize}
    \item \textbf{Case 1: $e = s_0$.}
      Trivially, $e' = s_0.$

    \item \textbf{Case 2: $e = t(e_1)$.}
      $\Irec{t(e_1)}$, so $\Irec{e_1}$. Thus, by the inductive hypothesis,
      there exists a join-free $e_1'$ such that $\Irec{e_1'}$ and $eval(e_1) =
      eval(e_1')$. Now, let $e' = t(e_1')$ which is clearly join-free.
      \[
        eval(e')
          = eval(t(e_1'))
          = t(eval(e_1'))
          = t(eval(e_1))
          = eval(t(e_1))
          = eval(e)
      \]
      This also implies that $\Irec{e'}$.

    \item \textbf{Case 3: $e = e_1 \join e_2$.}
      $\Irec{e_1 \join e_2}$, so $\Irec{e_1}$ and $\Irec{e_2}$. Thus, by the
      inductive hypothesis, there exist join-free expressions $e_1'$ and $e_2'$
      where $eval(e_1') = eval(e_1)$, $\Irec{e_1'}$, $eval(e_2') = eval(e_2)$,
      and $\Irec{e_2'}$. Let $e'' = e_1' \join e_2'$
      \begin{align*}
        eval(e'')
        &= eval(e_1' \join e_2') \\
        &= eval(e_1') \join eval(e_2') \\
        &= eval(e_1) \join eval(e_2) \\
        &= eval(e_1 \join e_2) \\
        &= eval(e)
      \end{align*}
      This implies that $\Irec{e''}$. Because $T$ is \dIreducible, there exists
      a join-free $e'$ such that $\Irec{e'}$ and $eval(e') = eval(e'') =
      eval(e)$.
  \end{itemize}

  Next, consider arbitrary expressions $e_1$ and $e_2$ where $\Irec{e_1}$ and
  $\Irec{e_2}$. To show that $T$ is \Iconfluent, we must show that $I(e_1 \join
  e_2)$. Using our little lemma above, we know there exists join-free $e_1'$
  and $e_2'$ where $eval(e_1') = eval(e_1)$, $\Irec{e_1'}$, $eval(e_2') =
  eval(e_2)$, and $\Irec{e_2'}$. Because $T$ is \dIconfluent, $I(e_1' \join
  e_2')$, and
  \[
    eval(e_1' \join e_2')
      = eval(e_1') \join eval(e_2')
      = eval(e_1) \join eval(e_2)
      = eval(e_1 \join e_2)
  \]
  Thus, $I(e_1 \join e_2)$.
\end{elidableproof}

\begin{claim}
  Consider a state-based object $(S, s_0, \join)$, a set of transactions $T$,
  and an invariant $I$. $T$ is \Iconfluent{} if the following criteria are met:
  \begin{enumerate}
    \item
      $(S, \join)$ is a semilattice.

    \item
      For every $t \in T$, there exists some $s_t \in S$ such that $t(s) = s
      \join s_t$.

    \item
      For every pair of transactions $t_1, t_2 \in T$ and for all states $s \in
      S$, if $I(s)$, $I(t_1(s))$, and $I(t_2(s))$, then $I(t_1(s) \join
      t_2(s))$.
  \end{enumerate}
\end{claim}
\begin{elidableproof}
  \newcommand{\bart}[1]{\overline{t_{#1}}}
  \newcommand{\baru}[1]{\overline{u_{#1}}}

  To show that $T$ is \Iconfluent{}, it suffices to show that $T$ is
  \dIconfluent{} and \dIreducible{} (by
  \clmref{DiconfluenceDireducibleImpliesIconfluence}). We begin by showing
  that $T$ is \dIconfluent{}. Let
  \[
    e_1 = t_n(t_{n-1}(\ldots (t_1(s_0))\ldots))
    \quad \text{and} \quad
    e_2 = u_m(u_{m-1}(\ldots (u_1(s_0))\ldots))
  \]
  be two arbitrary join-free expressions that recursively satisfy $I$. For ease
  of notation, let
  \[
    \bart{i} = t_i(\ldots(t_1(s_0))\ldots)
    \quad\text{and}\quad
    \baru{i} = u_j(\ldots(u_1(s_0))\ldots)
  \]
  We prove by strong induction on $m \in \nats$ that if $m = i + j$ where $0
  \leq i \leq n$ and $0 \leq j \leq m$, then $\Irec{\bart{i}(\baru{j}(s_0))}$.
  From this, it's immediate that $\Irec{\bart{n}(\baru{m}(s_0))}$, so
  $\Irec{e_1 \join e_2}$, which proves that $T$ is \dIconfluent{}.
  \begin{itemize}
    \item \textbf{Case $m = 0$.}
      $i = j = 0$, so $\bart{0}(\baru{0}(s_0)) = s_0$. $\Irec{s_0}$ because
      $\Irec{e_1}$.

    \item \textbf{Case $m = 1$.}
      Without loss of generality, assume $i = 1$ and $j = 0$. Then,
      \[
        \bart{1}(\baru{0}(s_0))
          = t_1(s_0)
      \]
      $\Irec{t_1(s_0)}$ because $\Irec{e_1}$.

    \item \textbf{Case $m \geq 2$.}
      If $i = 0$, then $j = m$ and $\bart{0}(s_0) \join \baru{j}(s_0) =
      \baru{j}(s_0)$ which recursively satisfies $I$ because $\Irec{e_2}$.
      Similarly if $j = 0$, then $i = m$ and $\bart{i}(s_0) \join \baru{0}(s_0)
      = \bart{i}(s_0)$ which recursively satisfies $I$ because $\Irec{e_1}$.
      %
      Otherwise, $i, j > 1$. Let
      \begin{align*}
        e_{i-1,j-1}
          &= \bart{i-1}(\baru{j-1}(s_0)) \\
        e_{i,j-1}
          &= \bart{i}(\baru{j-1}(s_0))
           = t_i(e_{i-1,j-1}) \\
        e_{i-1,j}
          &= \bart{i-1}(\baru{j}(s_0))
           = u_j(e_{i-1,j-1})
      \end{align*}
      By the inductive hypothesis, $\Irec{e_{i-1,j-1}}$, $\Irec{e_{i,j-1}}$,
      and $\Irec{e_{i-1,j}}$. By condition 3, $e_{i-1,j} \join e_{i,j-1} =
      \bart{i}(s_0) \join \baru{j}(s_0) = \bart{i}(\baru{j}(s_0))$ satisfies
      $I$. This implies that $\Irec{\bart{i}(\baru{j}(s_0))}$.
  \end{itemize}

  Next, we show that $T$ is \dIreducible{}. Again let
  \[
    e_1 = t_n(t_{n-1}(\ldots (t_1(s_0))\ldots))
    \quad \text{and} \quad
    e_2 = u_m(u_{m-1}(\ldots (u_1(s_0))\ldots))
  \]
  be two arbitrary join-free expressions that recursively satisfy $I$. We just
  proved that $\Irec{\bart{n}(\baru{m}(s_0))}$. Also, $eval(e_1 \join e_2) =
  eval(\bart{n}(\baru{m}(s_0)))$. $\bart{n}(\baru{m}(s_0))$ is a join-free
  expression, so $T$ is \dIreducible{}.
\end{elidableproof}
