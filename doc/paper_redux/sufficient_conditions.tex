\section{Sufficient Conditions}
In this section, we present sufficient (but not always necessary) conditions
for state-based and operation-based invariant confluence. We also explain
circumstances under which the sufficient conditions are also necessary.

\begin{definition}
  We say a state-based object is \defword{\Iclosed{}} if $I(s_0)$ and for all
  states $s_1$ and $s_2$, if $I(s_1)$ and $I(s_2)$, then $I(s_1 \join s_2)$.
  \[
    I(s_1) \land I(s_2) \implies I(s_1 \join s_2)
  \]
  Similarly, we say on operation-based object is \defword{\Iclosed{}} if
  $I(s_0)$ and for all states $s_1$ and $s_2$ and all transactions $t$, if
  $I(s_1)$, $I(s_2)$, and $I(t(s_1)(s_1))$, then $I(t(s_1)(s_2))$.
  \[
    I(s_1) \land I(s_2) \land I(t(s_1)(s_1)) \implies I(t(s_1)(s_2))
  \]

  \todo{%
    We probably don't want to include $I(s_0)$ in the definition of \Iclosed{}
    because it's a bit confusing.
  }
\end{definition}

\begin{claim}\clmlabel{statebasedsufficient}
  Given a state-based object $O = (S, s_0, \join)$, a set of transactions $T$,
  and an invariant $I$, if $O$ is \Iclosed{}, then $T$ is \Iconfluent.
\end{claim}
\begin{elidableproof}
  Let $e_1, e_2$ be expressions such that $\Irec{e_1}$ and $\Irec{e_2}$. Let
  $s_1 = eval(e_1)$ and $s_2 = eval(e_2)$. Then, $I(s_1)$ and $I(s_2)$, so
  $I(s_1 \join s_2)$ which implies $I(e_1 \join e_2)$. Thus, by
  \clmref{statebased_two_iconfluence_defs}, $T$ is \Iconfluent{}.
\end{elidableproof}

\begin{claim}\clmlabel{opbasedsufficient}
  Given a operation-based object $O = (S, s_0)$, a set of transactions $T$, and
  an invariant $I$, if $O$ is \Iclosed{}, then $T$ is \Iconfluent.
\end{claim}
\begin{elidableproof}
  Let $t \in T$ and $e_1, e_2$ be expressions such that $\Irec{e_1}$,
  $\Irec{e_2}$, and $I(t(e_1)(e_1))$. Let $s_1 = eval(e_1)$ and $s_2 =
  eval(s_2)$. Then, $I(s_1)$, $I(s_2)$, and $I(t(s_1)(s_1))$, so
  $I(t(s_1)(s_2))$. This implies $I(t(e_1)(e_2))$, so by
  \clmref{opbased_two_iconfluence_defs}, $T$ is \Iconfluent.
\end{elidableproof}

Unfortunately, the converses of \clmref{statebasedsufficient} and
\clmref{opbasedsufficient} are not true. Being \Iconfluent{} does not
necessarily imply being \Iclosed{}, as the next two examples show.

\begin{example}\examplelabel{statebasednotnecessary}
  Consider the state-based object $O = (S, s_0, \join)$ where $(S, \join)$ is
  $(\ints, \max) \times (\ints, \max)$ and $s_0 = (0, 0)$. Let $T$ consist of
  two transactions $t_{x+1} \defeq \lambda (x, y).\ (x + 1, y)$ and $t_{y-1} =
  \lambda (x, y).\ (x, y - 1)$. Let $I = \setst{(x, y)}{xy \leq 0}$.
  %
  $\setst{(x, y)}{\reachable{(x, y)}} = \nats \times -\nats \subseteq I$, so
  $T$ is \Iconfluent. However, let $s_1 = (-1, 1)$ and $s_2 = (1, -1)$.
  $I(s_1)$ and $I(s_2)$. However, $s_1 \join s_2 = (1, 1)$, and $\lnot I((1,
  1))$. Thus, $O$ is not \Iclosed{}.
\end{example}

\begin{example}
  Consider the operation-based object $O = (S, s_0)$ where $S$ is $\ints \times
  \ints$ and $s_0 = (0, 0)$. Let $T$ consist of two transactions $t_{x+1}
  \defeq \lambda s.\ \lambda (x, y).\ (x + 1, y)$ and $t_{y-1} = \lambda s.\
  \lambda (x, y).\ (x, y - 1)$. Let $I = \setst{(x, y)}{xy \leq 0}$.
  %
  $\setst{(x, y)}{\reachable{(x, y)}} = \nats \times -\nats \subseteq I$, so
  $T$ is \Iconfluent. However, let $s_1 = (1, -1)$ and $s_2 = (0, 1)$.
  $I(s_1)$, $I(s_2)$, and $I(t_{x+1}(s_1)(s_1))$. However, $t_{x+1}(s_1)(s_2) =
  (1, 1)$, and $\lnot I((1, 1))$. Thus, $O$ is not \Iclosed{}.
\end{example}

\input{not_necessary.fig}

Let's take a closer look at \exampleref{statebasednotnecessary} (illustrated in
\figref{statebasednotnecessary}) to understand why being \Iconfluent{} doesn't
imply being \Iclosed{}. Our counterexample considers points $s_1 = (-1, 1)$ and
$s_2 = (1, -1)$. $s_2$ is reachable, but $s_1$ is not. This is not a
coincidence! If we consider an \Iconfluent{} set of transactions, then any two
reachable points satisfy the invariant, and the join of the two points is again
reachable, so it must satisfy the invariant as well. The only way to join two
invariant satisfying points and end up not satisfying the invariant is if one
or both points are not reachable. Thus, if we know that $I$ is a subset of
reachable points, then being \Iconfluent{} and being \Iclosed{} are equivalent.

\begin{claim}\clmlabel{sufficientandnecessary}
  If every invariant satisfying state is reachable, then being \Iconfluent{}
  and being \Iclosed{} are equivalent. Being \Iclosed{} is always sufficient,
  but if we can establish that every invariant satisfying point is reachable,
  then being \Iclosed{} is a both necessary and sufficient for being
  \Iconfluent{}.
  \[
    I \subseteq \setst{e}{\reachable{e}} \implies
    (\text{\Iclosed{}} \iff \text{\Iconfluent})
  \]
\end{claim}
\begin{elidableproof}
  Consider a state-based object $O = (S, s_0, \join)$, a set of transactions
  $T$, and an invariant $I$ where $I \subseteq \setst{e}{\reachable{e}}$.
  %
  Being \Iclosed{} always implies being \Iconfluent{} whether or not $I
  \subseteq \setst{e}{\reachable{e}}$. Thus, we only have to prove that if $T$
  is \Iconfluent{}, then $O$ is \Iclosed. If $T$ is \Iconfluent{}, then
  $I(s_0)$. Next, let $s_1$ and $s_2$ be arbitrary states such that $I(s_1)$
  and $I(s_2)$. Both states satisfy the invariant, so both are reachable. That
  is, there exist expressions $e_1$ and $e_2$ where $eval(e_1) = s_1$  and
  $eval(e_2) = s_2$. $e_1 \join e_2$ is again reachable, so since $T$ is
  \Iconfluent{}, $I(e_1 \join e_2)$ which implies $I(s_1 \join s_2)$. Thus, $O$
  is \Iclosed.
\end{elidableproof}

Here are some more examples of transactions $T$ and invariants $I$ that are
\Iconfluent{} but not \Iclosed{}. \todo{Think of more compelling examples.}

\begin{example}
  \todo{Write this up in full.}
  Imagine we are building a system to group students together. We have a relation
  of (student id, grade) and a map (group id -> set of student ids). We want to
  enforce the invariant that every student in every group is in the same grade
  and that all groups are non-empty. If we start off with an initially empty
  mapping, then there are conflicts. If we start off with at least one student
  mapped into each group, then there are not any conflicts.
\end{example}

\begin{example}
  Consider the state-based object $(S, s_0, \join)$ where $(S, \join) = (\ints,
  \max) \times (\ints, \max)$ and $s_0 = (0, 0)$. Let $T = \set{(x, y) \mapsto
  (x + 1, y), (x, y) \mapsto (x, y - 1)}$ and let $I((x, y)) = xy \leq 0$. The
  reachable states are $\nats \times -\nats$, all of which satisfy $I$, so $T$
  is \Iconfluent{}. However, let $a = (-1, 1)$ and $b = (1, -1)$. $I(a)$ and
  $I(b)$, but $a \join b = (1, 1)$ does not satisfy $I$.
\end{example}

\begin{example}
  Consider the state-based object $(\powerset{\nats}, \set{0}, \cup)$. Let $T =
  \setst{X \mapsto X \cup Y}{Y \subseteq \nats}$ let $I(X) = \exists k \in
  \set{0, 1}.\ \forall x \in X.\ x \equiv k \mod 2$. That is $I(X)$ if $X$
  contains only odd or only even elements. The reachable states are
  $\powerset{2\nats}$, all of which satisfy $I$, so $T$ is \Iconfluent{}.
  However, let $A = \set{0}$ and $Y = \set{1}$. $I(A)$ and $I(B)$, but $A \join
  B = \set{0, 1}$ does not satisfy $I$.
\end{example}

\begin{example}
  Consider a state-based object consisting of two integer 2P-sets $(A_1, R_1)$ and
  $(A_2, R_2)$ with initial state $(\set{1, 3}, \emptyset{})$ and $(\set{1, 2,
  3, 4}, \emptyset{})$. Let $T$ consist of all transactions that either remove
  an element from the first 2P-set (i.e.\ add something to $R_1$) or add
  something to the second 2P-set (i.e.\ add something to $A_2$). Let $I$ be
  that the first 2P-set is a subset of the second (i.e. $(A_1 - R_1) \subseteq
  (A_2 - R_2)$).
  %
  $T$ is \Iconfluent{}. However, let $s_1 = (\set{1}, \set{2}, \set{1},
  \set{2})$ and $s_2 = (\set{2}, \set{1}, \set{2}, \set{1})$. $I(s_1)$ and
  $I(s_2)$, but $s_1 \cup s_2 = (\set{1, 2}, \set{1, 2}, \set{1, 2}, \set{1,
  2})$ which does not satisfy $I$.
\end{example}
