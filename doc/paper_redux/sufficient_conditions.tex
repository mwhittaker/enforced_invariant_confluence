\section{Sufficient Conditions}
In this section, we present sufficient conditions for state-based and
operation-based invariant confluence. It turns out that these conditions are
sufficient but not necessary. However, if we relax the assumption of a fixed
start state $s_0$, then they are both sufficient and necessary.

\begin{claim}\clmlabel{statebasedsufficient}
  If for all states $s_1$ and $s_2$, $I(s_1)$ and $I(s_2)$ implies $I(s_1 \join
  s_2)$, then $T$ is \Iconfluent{}. In other words, if invariant satisfying
  states are closed under join, then $T$ is \Iconfluent.
\end{claim}
\begin{proof}
  Let $e_1, e_2$ be expressions such that $\Irec{e_1}$ and $\Irec{e_2}$. Then,
  $I(eval(e_1))$ and $I(eval(e_2))$, so $I(eval(e_1) \join eval(e_2))$ which
  implies $I(e_1 \join e_2)$.
\end{proof}

\begin{claim}\clmlabel{opbasedsufficient}
  If for all transactions $t \in T$ and for all states $s_1$ and $s_2$,
  $I(s_1)$ and $I(s_2)$ and $I(t(s_1)(s_1))$ implies $I(t(s_1)(s_2))$, then $T$
  is \Iconfluent{}.
\end{claim}
\begin{proof}
  Let $t \in T$ and $e_1, e_2$ be expressions such that $\Irec{e_1}$,
  $\Irec{e_2}$, and $I(t(e_1)(e_2))$. Let $s_1 = eval(e_1)$ and $s_2 =
  eval(s_2)$. Then, $I(s_1)$, $I(s_2)$, and $I(t(s_1)(s_1))$, so
  $I(t(s_1)(s_2))$. This implies $I(t(e_1)(e_2))$.
\end{proof}

While the conditions in \clmref{statebasedsufficient} and
\clmref{opbasedsufficient} are sufficient, they are not necessary.

\begin{claim}\clmlabel{statebasednotnecessary}
  If $T$ is \Iconfluent, it may not satisfy the condition in
  \clmref{statebasedsufficient}.
\end{claim}
\begin{proof}
  Consider the state based object $(S, s_0, \join)$ where $S$ is the set of all
  finite non-empty sets of integers, $s_0 = \set{0}$, and $\join = \cup$. We
  have a single transaction $t(x) = x \cup \set{\max(x) + 2}$ which retrieves
  the largest element from the set (which is guaranteed to exist because it is
  finite and non-empty), adds two to it, and then adds it into the set. $T =
  \set{t}$. Let $I$ be the invariant that all elements of $S$ are either odd or
  even.

  Note that $T$ is \Iconfluent{}. Beginning with our initial state, we can
  derive states $\set{0}, \set{0, 2}, \set{0, 2, 4}, \ldots$ all of which
  satisfy the invariant. Moreover, merging any such states satisfies the
  invariant.
  %
  However, $T$ doesn't satisfy the condition in \clmref{statebasedsufficient}.
  $\set{0}$ and $\set{1}$ satisfy the invariant, but $\set{0} \cup \set{1}$
  does not.
\end{proof}

\begin{claim}\clmlabel{opbasednotnecessary}
  If $T$ is \Iconfluent, it may not satisfy the condition in
  \clmref{opbasedsufficient}.
\end{claim}
\begin{proof}
  We play the same trick as \clmref{statebasednotnecessary}. Let $S$, $s_0$,
  and $I$ be as in \clmref{statebasednotnecessary}. Consider a single
  transaction $t(x) = u_{\max(x) + 2}$ where $u_k(x) = x \cup \set{k}$. Let $T
  = \set{t}$.

  $T$ is \Iconfluent{}. Beginning with our initial state, we can derive any
  finite set of even integers containing $0$. All these states satisfy the
  invariant. Letting $s, s'$ be any of these states, $I(t(s)(s'))$.
  %
  However, $T$ doesn't satisfy the condition in \clmref{opbasedsufficient}.
  $\set{0}$ and $\set{1}$ satisfy the invariant, and so does
  $t(\set{0})(\set{0})$, but $t(\set{0})(\set{1}) = \set{1, 2}$ does not.
\end{proof}

\todo{Think of more compelling examples.}

The conditions in \clmref{statebasedsufficient} and \clmref{opbasedsufficient}
are not necessary. Intuitively, this makes quite a bit of sense. The condition
in \clmref{statebasedsufficient} doesn't depend on $T$ and neither condition
depends on the initial state $s_0$. However, if we relax our assumption of a
fixed start state $s_0$ and instead allow replicas to begin with an arbitrary
state, then both conditions are sufficient and necessary. Alternatively, if
every state in $S$ is reachable from $s_0$, then the conditions are sufficient
and necessary.

\todo{Prove these facts more carefully. It's pretty straightforward though.}

\todo{Write this up in full.}
Imagine we are building a system to group students together. We have a relation
of (student id, grade) and a map (group id -> set of student ids). We want to
enforce the invariant that every student in every group is in the same grade
and that all groups are non-empty. If we start off with an initially empty
mapping, then there are conflicts. If we start off with at least one student
mapped into each group, then there are not any conflicts.

% | Data Model                              | I           | SC  | T | IC  |
% | State based set with union              | phi(x)      | yes |   | yes |
% | State based two sets with union         | foreign key | yes |   | yes |
% | State-based increment-decrement counter | >           |

Here are some examples of transactions $T$ and invariants $I$ that do not
satisfy \clmlabel{statebasedsufficient} but are \Iconfluent{}.

\begin{example}
  Consider the state-based object $(S, s_0, \join)$ where $(S, \join) = (\ints,
  \max) \times (\ints, \max)$ and $s_0 = (0, 0)$. Let $T = \set{(x, y) \mapsto
  (x + 1, y), (x, y) \mapsto (x, y - 1)}$ and let $I((x, y)) = xy \leq 0$. The
  reachable states are $\nats \times -\nats$, all of which satisfy $I$, so $T$
  is \Iconfluent{}. However, let $a = (-1, 1)$ and $b = (1, -1)$. $I(a)$ and
  $I(b)$, but $a \join b = (1, 1)$ does not satisfy $I$.
\end{example}

\begin{example}
  Consider the state-based object $(\powerset{\nats}, \set{0}, \cup)$. Let $T =
  \setst{X \mapsto X \cup Y}{Y \subseteq \nats}$ let $I(X) = \exists k \in
  \set{0, 1}.\ \forall x \in X.\ x \equiv k \mod 2$. That is $I(X)$ if $X$
  contains only odd or only even elements. The reachable states are
  $\powerset{2\nats}$, all of which satisfy $I$, so $T$ is \Iconfluent{}.
  However, let $A = \set{0}$ and $Y = \set{1}$. $I(A)$ and $I(B)$, but $A \join
  B = \set{0, 1}$ does not satisfy $I$.
\end{example}

\begin{example}
  Consider a state-based object consisting of two integer 2P-sets $(A_1, R_1)$ and
  $(A_2, R_2)$ with initial state $(\set{1, 3}, \emptyset{})$ and $(\set{1, 2,
  3, 4}, \emptyset{})$. Let $T$ consist of all transactions that either remove
  an element from the first 2P-set (i.e.\ add something to $R_1$) or add
  something to the second 2P-set (i.e.\ add something to $A_2$). Let $I$ be
  that the first 2P-set is a subset of the second (i.e. $(A_1 - R_1) \subseteq
  (A_2 - R_2)$).
  %
  $T$ is \Iconfluent{}. However, let $s_1 = (\set{1}, \set{2}, \set{1},
  \set{2})$ and $s_2 = (\set{2}, \set{1}, \set{2}, \set{1})$. $I(s_1)$ and
  $I(s_2)$, but $s_1 \cup s_2 = (\set{1, 2}, \set{1, 2}, \set{1, 2}, \set{1,
  2})$ which does not satisfy $I$.
\end{example}
